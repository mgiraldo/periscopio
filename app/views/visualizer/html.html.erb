<% content_for :dynamic_headers do %>
<link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://code.leafletjs.com/leaflet-0.3.1/leaflet.ie.css" />
<![endif]-->
<% end %>

<h1>Visualizer</h1>
<input type="button" id="play-btn" value="loading..." />
<div id="year"></div>
<div id="year-slider"></div>
<div id="mb-map"></div>
<div id="chart"></div>
<script type="text/javascript">
	var actors = ["","DEL","ELN","FARC","AUC"];
	var tilejson = {
		tilejson : '1.0.0',
		scheme : 'xyz',
		tiles : ['http://a.tiles.mapbox.com/v3/mga.periscopio-base/{z}/{x}/{y}.png']
	};
	var map;
	var chart;
	var hasPlotLine = false;
	var violenceData = {};
	var dataLayers = {};
	var currentLayer;
	var url = 'http://a.tiles.mapbox.com/v3/mga.periscopio-base.jsonp';
	var playing = false;
	var intervalId;
	var years = [];
	var step = 0;
	function createMap () {
		wax.tilejson(url,
		    function(tilejson) {
		    	// -88.8794,-9.7740,-56.3159,17.6650
		    	var NE = new L.LatLng(17.6650,-88.8794),
				SW = new L.LatLng(-9.7740,-56.3159),
				bounds = new L.LatLngBounds(SW, NE);
		        map = new L.Map('mb-map', {minZoom: 5, maxZoom: 9, maxBounds:bounds})
		          .addLayer(new wax.leaf.connector(tilejson))
		          .setView(new L.LatLng(tilejson.center[1], tilejson.center[0]), tilejson.center[2]);
				wax.leaf.interaction(map, tilejson);
		});
		//var layer = new wax.leaf.connector(tilejson); // Returns a new L.TileLayer object.
	}
	function plotYear(year) {
		$("#year").html("AÃ±o: " + year);
		if (currentLayer!=undefined) {
			map.removeLayer(currentLayer);
		}
		if (dataLayers[year]==undefined) {
			console.log("no layer");
			// create the dot group layer
			dataLayers[year] = new L.LayerGroup();
			var yearData = violenceData[year];
			// process each dot
			var i,l=yearData.length;
			for (i=0;i<l;++i) {
				var info = yearData[i].properties;
				var coords = yearData[i].geometry.coordinates;
				// area represents deaths
				// area = pi * (radius^2)
				var r = Math.round(Math.sqrt(info.total/Math.PI));
				var dot = new L.CircleMarker( new L.LatLng(coords[1],coords[0]), 
					{radius:r, color:'#813', fillColor:'#d60000', stroke:false, fillOpacity: 1} 
				);
				var popString = "<strong>" + info.city + ", " + info.department + "</strong><br />";
				popString += actors[1] + ": " + info.total_1 + "<br />";
				popString += actors[2] + ": " + info.total_2 + "<br />";
				popString += actors[3] + ": " + info.total_3 + "<br />";
				popString += actors[4] + ": " + info.total_4 + "<br />";
				popString += "TOTAL: " + info.total + "<br />";
				dot.bindPopup(popString);
				dataLayers[year].addLayer(dot);
			}
		}
		currentLayer = dataLayers[year];
		map.addLayer(currentLayer);
		if (hasPlotLine) {
			chart.xAxis[0].removePlotLine('year-line');
		}
		chart.xAxis[0].addPlotLine({
			color: '#ff0000',
			width: 1,
			value: years.indexOf(year),
			id: 'year-line'
		});
		hasPlotLine = true;
	}
	function init() {
		createMap();
		$("#year-select").change(
			function () {
				plotYear($(this).val());
			}
		);
		$("#year-slider").slider({ min: 1988, max: 2005 });
		$( "#year-slider" ).slider({
			change: function(event, ui) {
				if (!playing) {
					plotYear($(this).slider("value"));
				}
			},
			click: function(event, ui) {
				if(playing) {
					stopAnimation();
				}
			}
		});
		loadData();
	}
	function loadData() {
		var dataurl = '/api.json';
		$.getJSON(dataurl, function(data) {
			//console.log(data);
			// process each dot
			var i,l=data.features.length;
			var lastYear = 0;
			var k = -1;
			violenceData = {
				xAxis: {categories: [], labels: {style:{fontSize: '9px'}}},
				yAxis: {min: 0, max: 0, endOnTick: false, gridLineWidth: 0},
				series: []
			};
			violenceData.series.push({});
			violenceData.series.push({name:actors[1],data:[]});
			violenceData.series.push({name:actors[2],data:[]});
			violenceData.series.push({name:actors[3],data:[]});
			violenceData.series.push({name:actors[4],data:[]});
			for (i=0;i<l;++i) {
				if (data.features[i].properties.year_of!=lastYear) {
					k++;
					// new year... create array
					lastYear = data.features[i].properties.year_of;
					violenceData[lastYear] = [];
					violenceData.xAxis.categories.push(lastYear);
					violenceData.series[1].data[k] = 0;
					violenceData.series[2].data[k] = 0;
					violenceData.series[3].data[k] = 0;
					violenceData.series[4].data[k] = 0;
					years.push(lastYear);
				}
				violenceData.series[1].data[k] += data.features[i].properties.total_1;
				violenceData.series[2].data[k] += data.features[i].properties.total_2;
				violenceData.series[3].data[k] += data.features[i].properties.total_3;
				violenceData.series[4].data[k] += data.features[i].properties.total_4;
				if (violenceData.yAxis.max < Math.max(violenceData.series[1].data[k],violenceData.series[2].data[k],violenceData.series[3].data[k],violenceData.series[4].data[k])) {
					violenceData.yAxis.max = 1000 + Math.max(violenceData.series[1].data[k],violenceData.series[2].data[k],violenceData.series[3].data[k],violenceData.series[4].data[k])
				}
				violenceData[lastYear].push(data.features[i]);
			}
			violenceData.series.shift();
			//console.log(violenceData);
			plotChart();
			plotYear(1988);
			enablePlay();
		});
	}
	function plotChart() {
		chart = new Highcharts.Chart(
			{
				chart: {
					renderTo: 'chart',
					type: 'line',
					backgroundColor: "#001420",
					borderColor: "#001420",
					borderRadius: 0,
					animation: false,
					marginRight: 0,
					marginBottom: 20,
					marginLeft: 0
				},
				plotOptions: {
					line : {
						lineWidth: 1,
						marker: {
							enabled: false,
							states: {
								hover: {
									enabled: true,
									symbol: 'circle',
									radius: 0.5,
									lineWidth: 1
								}
							}
						}
					}
				},
				credits: {enabled:false},
				legend: {enabled:false},
				title: {text:null},
				xAxis: violenceData.xAxis,
				yAxis: violenceData.yAxis,
				series: violenceData.series
			}
		);
	}
	function playAnimation() {
		playing = true;
		intervalId = setInterval(nextStep,300);
		$("#year-slider").slider("disable");
	}
	function stopAnimation() {
		playing = false;
		clearInterval(intervalId);
		$("#year-slider").slider("enable");
	}
	function nextStep() {
		step++;
		if (step>=years.length) {
			step=0;
		}
		$("#year-slider").slider("value",years[step]);
		plotYear(years[step]);
	}
	function enablePlay() {
		$("#play-btn").val("Play");
		$("#play-btn").toggle(function (){
			$(this).val("Pause");
			playAnimation();
		}, function(){
			$(this).val("Play");
			stopAnimation();
		});
	}
	init();
</script>